<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø´ØªØ±Ø§Ú© VPN (Ø¢Ù†Ù„Ø§ÛŒÙ†)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #008B8B;
            --secondary-color: #f0f5f5;
            --light-color: #ffffff;
            --dark-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --archive-color: #7f8c8d;
            --info-color: #3498db;
            --gemini-color: #9b59b6; /* Purple for Gemini feature */
            --shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            --border-radius: 10px;
        }
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--secondary-color);
            color: var(--dark-color);
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .hidden { display: none !important; }
        .auth-container {
            background-color: var(--light-color);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }
        .auth-container h2 { color: var(--primary-color); margin-bottom: 25px; }
        .auth-container .form-group { margin-bottom: 20px; text-align: right; }
        .auth-container input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .auth-container .btn { width: 100%; margin-bottom: 10px; }
        .auth-container #auth-error, .auth-container #auth-success {
            font-weight: 500;
            min-height: 20px;
            margin-top: 15px;
        }
        #auth-error { color: var(--danger-color); }
        #auth-success { color: var(--success-color); }
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 20px;
            padding: 30px;
            background: var(--light-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        h1, h2 { color: var(--primary-color); text-align: center; margin-bottom: 30px; }
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #subscriptionForm {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 8px; font-weight: 500; font-size: 14px; }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Vazirmatn', sans-serif;
            box-sizing: border-box;
            background-color: #fdfdfd;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 139, 139, 0.15);
        }
        .form-buttons { grid-column: 1 / -1; display: flex; gap: 10px; }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            color: var(--light-color);
            cursor: pointer;
            font-size: 16px;
            font-family: 'Vazirmatn', sans-serif;
            font-weight: 500;
            transition: all 0.3s;
            flex-grow: 1;
        }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-submit { background-color: var(--primary-color); }
        .btn-logout { background-color: var(--danger-color); flex-grow: 0; }
        .btn-secondary { background-color: var(--archive-color); }
        .toolbar { display: flex; justify-content: flex-start; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0; }
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; text-align: right; font-size: 14px; }
        th, td { padding: 15px; border-bottom: 1px solid #e0e0e0; }
        th { background-color: #f8f9fa; color: var(--dark-color); font-weight: 700; }
        tr:hover { background-color: #e9ecef; }
        td.link-cell { max-width: 250px; word-wrap: break-word; text-align: left; direction: ltr; }
        td.link-cell a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        td.actions { display: flex; gap: 8px; justify-content: center; align-items: center; }
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 13px;
            font-weight: 500;
        }
        .btn-edit { background-color: var(--warning-color); color: var(--dark-color); }
        .btn-delete { background-color: var(--danger-color); }
        .btn-archive { background-color: var(--success-color); }
        .btn-unarchive { background-color: var(--info-color); }
        .btn-gemini { background-color: var(--gemini-color); }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: var(--border-radius);
            position: relative;
        }
        .close-btn {
            color: #aaa;
            position: absolute;
            left: 15px;
            top: 10px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        #gemini-textarea {
            width: 100%;
            height: 150px;
            margin-top: 15px;
            margin-bottom: 15px;
            resize: vertical;
        }
        #app-loader {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    
    <div id="auth-container" class="auth-container">
        <!-- Auth forms remain the same -->
        <form id="login-form"><h2>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„</h2><div class="form-group"><label for="login-email">Ø§ÛŒÙ…ÛŒÙ„</label><input type="email" id="login-email" required></div><div class="form-group"><label for="login-password">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label><input type="password" id="login-password" required></div><button type="submit" class="btn btn-submit">ÙˆØ±ÙˆØ¯</button><p>Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ <a href="#" id="show-register">Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯</a></p><p id="auth-error"></p></form><form id="register-form" class="hidden"><h2>Ø«Ø¨Øª Ù†Ø§Ù…</h2><div class="form-group"><label for="register-email">Ø§ÛŒÙ…ÛŒÙ„</label><input type="email" id="register-email" required></div><div class="form-group"><label for="register-password">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ø­Ø¯Ø§Ù‚Ù„ Û¶ Ú©Ø§Ø±Ø§Ú©ØªØ±)</label><input type="password" id="register-password" required></div><button type="submit" class="btn btn-submit">Ø«Ø¨Øª Ù†Ø§Ù…</button><p>Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ <a href="#" id="show-login">ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</a></p><p id="auth-success"></p></form>
    </div>

    <div class="container hidden" id="main-app">
        <div id="app-loader">
            <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</p>
        </div>

        <div id="app-content" class="hidden">
            <!-- Main app structure remains the same -->
            <div class="header-controls"><h1>ğŸ“ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø´ØªØ±Ø§Ú© VPN</h1><button id="logout-btn" class="btn btn-logout">Ø®Ø±ÙˆØ¬</button></div><form id="subscriptionForm"><input type="hidden" id="editId"><div class="form-group"><label for="customerName">Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ</label><input type="text" id="customerName" required></div><div class="form-group"><label for="phoneNumber">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</label><input type="tel" id="phoneNumber"></div><div class="form-group"><label for="botUsername">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Ø±Ø¨Ø§Øª</label><input type="text" id="botUsername"></div><div class="form-group"><label for="botName">Ø§Ù†ØªØ®Ø§Ø¨ Ø±Ø¨Ø§Øª</label><select id="botName"><option value="Lemos">Lemos</option><option value="Sabz">Sabz</option></select></div><div class="form-group"><label for="subscriptionDate">ØªØ§Ø±ÛŒØ®</label><input type="text" id="subscriptionDate" data-jdp required autocomplete="off"></div><div class="form-group"><label for="subscriptionVolume">Ø­Ø¬Ù… Ø§Ø´ØªØ±Ø§Ú© (GB)</label><input type="number" id="subscriptionVolume" min="1"></div><div class="form-group" style="grid-column: 1 / -1;"><label for="subscriptionLink">Ù„ÛŒÙ†Ú© Ø§Ø´ØªØ±Ø§Ú©</label><input type="url" id="subscriptionLink"></div><div class="form-buttons"><button type="submit" class="btn btn-submit" id="submitBtn">Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button></div></form><div class="form-buttons" style="margin-top: 20px; justify-content: center;"><button class="btn btn-secondary" id="toggleArchiveView">ğŸ—„ï¸ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ</button></div><div class="toolbar"><div class="form-group"><label for="sortOptions">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ</label><select id="sortOptions"><option value="createdAt-desc">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø«Ø¨Øª</option><option value="createdAt-asc">Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ† Ø«Ø¨Øª</option><option value="date-desc">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§Ø´ØªØ±Ø§Ú©</option><option value="date-asc">Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ† Ø§Ø´ØªØ±Ø§Ú©</option></select></div></div><div id="activeSubscriptions"><h2>Ù„ÛŒØ³Øª Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</h2><div class="table-container"><table id="activeTable"><thead><tr><th>Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ</th><th>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</th><th>Ø±Ø¨Ø§Øª</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø­Ø¬Ù… (GB)</th><th>Ù„ÛŒÙ†Ú©</th><th style="text-align: center;">Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody id="activeBody"></tbody></table></div></div><div id="archivedSubscriptions" class="hidden"><h2>Ù„ÛŒØ³Øª Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ</h2><div class="table-container"><table id="archivedTable"><thead><tr><th>Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ</th><th>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</th><th>Ø±Ø¨Ø§Øª</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø­Ø¬Ù… (GB)</th><th>Ù„ÛŒÙ†Ú©</th><th style="text-align: center;">Ø¹Ù…Ù„ÛŒØ§Øª</th></tr></thead><tbody id="archivedBody"></tbody></table></div></div>
        </div>
    </div>

    <!-- Gemini Modal -->
    <div id="gemini-modal" class="modal hidden">
        <div class="modal-content">
            <span id="close-gemini-modal" class="close-btn">&times;</span>
            <h3>âœ¨ Ù¾ÛŒØ§Ù… Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡</h3>
            <div id="gemini-loader">
                <p>Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ...</p>
            </div>
            <div id="gemini-result" class="hidden">
                <textarea id="gemini-textarea" readonly></textarea>
                <button id="copy-gemini-btn" class="btn btn-submit">Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù…ØªÙ†</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs (Updated Versions) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script src="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.js"></script>
    
    <script>
        // Firebase configuration from the user
        const firebaseConfig = {
          apiKey: "AIzaSyB0SVNq5CWwfkpddE6Lc0550yo-_gsfYgU",
          authDomain: "myvpnmanager.firebaseapp.com",
          projectId: "myvpnmanager",
          storageBucket: "myvpnmanager.firebasestorage.app",
          messagingSenderId: "1057582190073",
          appId: "1:1057582190073:web:1090800449575db220c128"
        };

        // --- Configuration Check ---
        if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("...")) {
            document.body.innerHTML = `<div style="text-align: center; padding: 40px; font-family: 'Vazirmatn', sans-serif; color: #2c3e50;"><h1 style="color: #e74c3c;">Ø®Ø·Ø§ÛŒ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ</h1><p style="font-size: 1.2rem;">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Firebase Ø¯Ø± Ú©Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p><p>Ù„Ø·ÙØ§Ù‹ Ù…Ø±Ø§Ø­Ù„ Ú¯ÙØªÙ‡ Ø´Ø¯Ù‡ Ø¯Ø± Ø±Ø§Ù‡Ù†Ù…Ø§ Ø±Ø§ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù‡ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª <strong>firebaseConfig</strong> Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± ÙØ§ÛŒÙ„ HTML Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.</p></div>`;
            throw new Error("Firebase config is missing or incomplete.");
        }

        // --- Initialize Firebase ---
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ ÙØ§ÛŒØ±Ø¨ÛŒØ³. Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª firebaseConfig Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.');
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements ---
        const authContainer = document.getElementById('auth-container');
        const mainApp = document.getElementById('main-app');
        const appLoader = document.getElementById('app-loader');
        const appContent = document.getElementById('app-content');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showLoginLink = document.getElementById('show-login');
        const showRegisterLink = document.getElementById('show-register');
        const logoutBtn = document.getElementById('logout-btn');
        const authError = document.getElementById('auth-error');
        const authSuccess = document.getElementById('auth-success');
        const geminiModal = document.getElementById('gemini-modal');
        const closeGeminiModalBtn = document.getElementById('close-gemini-modal');
        const geminiLoader = document.getElementById('gemini-loader');
        const geminiResult = document.getElementById('gemini-result');
        const geminiTextarea = document.getElementById('gemini-textarea');
        const copyGeminiBtn = document.getElementById('copy-gemini-btn');


        // --- Auth UI Logic ---
        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); authError.textContent = ''; });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); authSuccess.textContent = ''; });

        // --- Firebase Auth ---
        registerForm.addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; auth.createUserWithEmailAndPassword(email, password).then(userCredential => { authSuccess.textContent = 'Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ² Ø¨ÙˆØ¯! Ø§Ú©Ù†ÙˆÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.'; registerForm.reset(); showLoginLink.click(); }).catch(error => { authError.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ø§Ù…: ' + error.message; }); });
        loginForm.addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; auth.signInWithEmailAndPassword(email, password).catch(error => { authError.textContent = 'Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.'; }); });
        logoutBtn.addEventListener('click', () => { auth.signOut(); });

        // --- Auth State Observer ---
        auth.onAuthStateChanged(user => { if (user) { authContainer.classList.add('hidden'); mainApp.classList.remove('hidden'); initializeApp(user); } else { mainApp.classList.add('hidden'); authContainer.classList.remove('hidden'); loginForm.reset(); registerForm.reset(); } });

        // --- MAIN APP LOGIC ---
        function initializeApp(user) {
            appLoader.classList.remove('hidden');
            appContent.classList.add('hidden');
            
            jalaliDatepicker.startWatch({ time: false, todayButton: true, gotoToday: true });

            const form = document.getElementById('subscriptionForm');
            const submitBtn = document.getElementById('submitBtn');
            const editIdInput = document.getElementById('editId');
            const toggleArchiveViewBtn = document.getElementById('toggleArchiveView');
            const activeBody = document.getElementById('activeBody');
            const archivedBody = document.getElementById('archivedBody');
            const activeContainer = document.getElementById('activeSubscriptions');
            const archivedContainer = document.getElementById('archivedSubscriptions');
            const sortOptions = document.getElementById('sortOptions');

            let currentSort = 'createdAt-desc';
            let subscriptions = [];
            let archived = [];
            
            const subscriptionsRef = db.collection('users').doc(user.uid).collection('subscriptions');
            const archivedRef = db.collection('users').doc(user.uid).collection('archived');
            
            let activeLoaded = false;
            let archivedLoaded = false;

            const showAppContent = () => {
                if(activeLoaded && archivedLoaded) {
                    appLoader.classList.add('hidden');
                    appContent.classList.remove('hidden');
                }
            }

            subscriptionsRef.onSnapshot(snapshot => { subscriptions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); activeLoaded = true; showAppContent(); renderTables(); }, error => console.error("Error listening to active subscriptions: ", error));
            archivedRef.onSnapshot(snapshot => { archived = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); archivedLoaded = true; showAppContent(); renderTables(); }, error => console.error("Error listening to archived subscriptions: ", error));

            sortOptions.addEventListener('change', (e) => { currentSort = e.target.value; renderTables(); });

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const subscriptionData = { customerName: document.getElementById('customerName').value, phoneNumber: document.getElementById('phoneNumber').value, botUsername: document.getElementById('botUsername').value, botName: document.getElementById('botName').value, subscriptionDate: document.getElementById('subscriptionDate').value, subscriptionLink: document.getElementById('subscriptionLink').value, subscriptionVolume: document.getElementById('subscriptionVolume').value, };
                const editId = editIdInput.value;
                if (editId) { subscriptionsRef.doc(editId).update(subscriptionData); submitBtn.textContent = 'Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª'; submitBtn.style.backgroundColor = 'var(--primary-color)'; editIdInput.value = ''; } else { subscriptionData.createdAt = firebase.firestore.FieldValue.serverTimestamp(); subscriptionsRef.add(subscriptionData); }
                form.reset();
            });

            toggleArchiveViewBtn.addEventListener('click', () => { archivedContainer.classList.toggle('hidden'); activeContainer.classList.toggle('hidden'); toggleArchiveViewBtn.textContent = archivedContainer.classList.contains('hidden') ? 'ğŸ—„ï¸ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ' : 'âœ… Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„ÛŒØ³Øª ÙØ¹Ø§Ù„'; });

            // --- Event Delegation for action buttons ---
            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('.action-btn');
                if (!target || !mainApp.contains(target)) return;
                const id = target.dataset.id;
                
                if (target.classList.contains('btn-edit')) handleEdit(id);
                else if (target.classList.contains('btn-delete')) handleDelete(id, target.dataset.list);
                else if (target.classList.contains('btn-archive')) handleArchive(id);
                else if (target.classList.contains('btn-unarchive')) handleUnarchive(id);
                else if (target.classList.contains('btn-gemini')) handleGenerateMessage(id);
            });

            // --- Gemini Modal Logic ---
            closeGeminiModalBtn.addEventListener('click', () => geminiModal.classList.add('hidden'));
            copyGeminiBtn.addEventListener('click', () => {
                geminiTextarea.select();
                document.execCommand('copy');
                copyGeminiBtn.textContent = 'Ú©Ù¾ÛŒ Ø´Ø¯!';
                setTimeout(() => { copyGeminiBtn.textContent = 'Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù…ØªÙ†'; }, 2000);
            });

            async function handleGenerateMessage(id) {
                const sub = subscriptions.find(s => s.id === id);
                if (!sub) return;

                geminiModal.classList.remove('hidden');
                geminiLoader.classList.remove('hidden');
                geminiResult.classList.add('hidden');

                const prompt = `ÛŒÚ© Ù¾ÛŒØ§Ù… Ú©ÙˆØªØ§Ù‡ØŒ Ø¯ÙˆØ³ØªØ§Ù†Ù‡ Ùˆ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒ VPN Ø¨Ù‡ Ù†Ø§Ù… "${sub.customerName}" Ø¨Ù†ÙˆÛŒØ³. Ø¨Ù‡ Ø§Ùˆ Ø§Ø·Ù„Ø§Ø¹ Ø¨Ø¯Ù‡ Ú©Ù‡ Ø§Ø´ØªØ±Ø§Ú© Ø¬Ø¯ÛŒØ¯Ø´ Ø±ÙˆÛŒ Ø±Ø¨Ø§Øª "${sub.botName}" ÙØ¹Ø§Ù„ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø¯Ø± Ù¾Ø§ÛŒØ§Ù† Ø§Ø² Ø®Ø±ÛŒØ¯ Ø§Ùˆ ØªØ´Ú©Ø± Ú©Ù†.`;

                try {
                    const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // API key is handled by the environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates[0].content.parts[0].text;
                    
                    geminiTextarea.value = text;
                    geminiLoader.classList.add('hidden');
                    geminiResult.classList.remove('hidden');

                } catch (error) {
                    console.error("Gemini API error:", error);
                    geminiTextarea.value = "Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ§Ù…. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.";
                    geminiLoader.classList.add('hidden');
                    geminiResult.classList.remove('hidden');
                }
            }

            function handleEdit(id) {
                const sub = subscriptions.find(s => s.id === id);
                if (!sub) return;
                document.getElementById('customerName').value = sub.customerName;
                document.getElementById('phoneNumber').value = sub.phoneNumber;
                document.getElementById('botUsername').value = sub.botUsername;
                document.getElementById('botName').value = sub.botName;
                document.getElementById('subscriptionDate').value = sub.subscriptionDate;
                document.getElementById('subscriptionLink').value = sub.subscriptionLink;
                document.getElementById('subscriptionVolume').value = sub.subscriptionVolume;
                editIdInput.value = id;
                submitBtn.textContent = 'Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª';
                submitBtn.style.backgroundColor = 'var(--warning-color)';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function handleDelete(id, listType) {
                if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø§Ø´ØªØ±Ø§Ú© Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                    const ref = listType === 'active' ? subscriptionsRef : archivedRef;
                    ref.doc(id).delete();
                }
            }

            function handleArchive(id) {
                const docRef = subscriptionsRef.doc(id);
                docRef.get().then(doc => {
                    if (doc.exists) {
                        archivedRef.doc(id).set(doc.data());
                        docRef.delete();
                    }
                });
            }

            function handleUnarchive(id) {
                const docRef = archivedRef.doc(id);
                docRef.get().then(doc => {
                    if (doc.exists) {
                        subscriptionsRef.doc(id).set(doc.data());
                        docRef.delete();
                    }
                });
            }

            function renderTables() {
                const sortArray = (arr, sortType) => {
                    const sorted = [...arr];
                    sorted.sort((a, b) => {
                        if (sortType === 'createdAt-desc') return (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0);
                        if (sortType === 'createdAt-asc') return (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0);
                        if (sortType === 'date-desc') return (b.subscriptionDate || '').localeCompare(a.subscriptionDate || '');
                        if (sortType === 'date-asc') return (a.subscriptionDate || '').localeCompare(b.subscriptionDate || '');
                        return 0;
                    });
                    return sorted;
                };
                activeBody.innerHTML = sortArray(subscriptions, currentSort).map(sub => createRow(sub, 'active')).join('');
                archivedBody.innerHTML = sortArray(archived, currentSort).map(sub => createRow(sub, 'archived')).join('');
            }

            function createRow(sub, type) {
                const archiveBtn = type === 'active' ? `<button class="action-btn btn-archive" data-id="${sub.id}">Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ</button>` : `<button class="action-btn btn-unarchive" data-id="${sub.id}">Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ</button>`;
                const editBtn = type === 'active' ? `<button class="action-btn btn-edit" data-id="${sub.id}">ÙˆÛŒØ±Ø§ÛŒØ´</button>` : '';
                const geminiBtn = type === 'active' ? `<button class="action-btn btn-gemini" data-id="${sub.id}">âœ¨ Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ§Ù…</button>` : '';
                return `
                    <tr>
                        <td>${sub.customerName || '-'}</td>
                        <td>${sub.phoneNumber || '-'}</td>
                        <td>${sub.botName || '-'}</td>
                        <td>${sub.subscriptionDate || '-'}</td>
                        <td>${sub.subscriptionVolume ? sub.subscriptionVolume + ' GB' : '-'}</td>
                        <td class="link-cell">${sub.subscriptionLink ? `<a href="${sub.subscriptionLink}" target="_blank">${sub.subscriptionLink}</a>` : '-'}</td>
                        <td class="actions">${geminiBtn}${editBtn}<button class="action-btn btn-delete" data-id="${sub.id}" data-list="${type}">Ø­Ø°Ù</button>${archiveBtn}</td>
                    </tr>`;
            }
        }
    </script>
</body>
</html>
